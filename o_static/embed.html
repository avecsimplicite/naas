<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Download PNG</title>
  <style>
    html,body{height:100%;margin:0}
    body{display:flex;align-items:center;justify-content:center;font-family:Arial,Helvetica,sans-serif;background:#f6f6f6}
    .btn{background:#007bff;color:#fff;border:none;padding:22px 36px;font-size:18px;border-radius:10px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.12)}
    .status{position:fixed;left:16px;bottom:16px;font-size:13px;color:#333}
    #offscreen { position: absolute; left: -9999px; top: 0; width: fit-content; display: inline-block; }
    table{border-collapse:collapse;background:#fff}
    table th, table td{border:1px solid #ddd;padding:6px 10px;text-align:left}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <button id="download" class="btn">Download PNG</button>
  <div class="status" id="status">Ready</div>
  <div id="offscreen" aria-hidden="true"></div>

<script>
const PROXY = 'https://api.allorigins.win/raw?url=';
const statusEl = document.getElementById('status');
const off = document.getElementById('offscreen');
const btn = document.getElementById('download');

function setStatus(s){ statusEl.textContent = s; }
function getParam(name){ const u = new URL(location.href); return u.searchParams.get(name); }

function makeCsvUrl(publishedUrl){
  try{ const u = new URL(publishedUrl); u.searchParams.set('output','csv'); return u.toString(); }
  catch(e){ return publishedUrl.includes('?') ? publishedUrl + '&output=csv' : publishedUrl + '?output=csv'; }
}

function renderTable(rows){
  off.innerHTML = '';
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const tbody = document.createElement('tbody');
  if(!rows || rows.length===0){ off.textContent='No data'; return table; }
  const header = rows[0];
  const hr = document.createElement('tr');
  header.forEach(h => { const th = document.createElement('th'); th.textContent = h; hr.appendChild(th); });
  thead.appendChild(hr);
  for(let i=1;i<rows.length;i++){ const r = rows[i]; const tr = document.createElement('tr'); r.forEach(c=>{ const td=document.createElement('td'); td.textContent = c; tr.appendChild(td); }); tbody.appendChild(tr); }
  table.appendChild(thead); table.appendChild(tbody); off.appendChild(table); return table;
}

async function tryFetchCsv(csvUrl){
  setStatus('Fetching CSV...');
  const res = await fetch(csvUrl);
  if(!res.ok) throw new Error('Fetch failed: '+res.status);
  const txt = await res.text();
  const parsed = Papa.parse(txt.trim());
  return parsed.data;
}

function extractIdsFromUrl(url){
  try{ const u = new URL(url); const m = u.pathname.match(/\/d\/([a-zA-Z0-9-_]+)/); const id = m?m[1]:null; const gid = u.searchParams.get('gid')||null; return {id,gid}; }catch(e){return {id:null,gid:null}} }

function loadViaGvizScript(publishedUrl){
  return new Promise((resolve,reject)=>{
    const {id,gid} = extractIdsFromUrl(publishedUrl);
    if(!id) return reject(new Error('No spreadsheet id found'));
    const sheetGid = gid||'0';
    const src = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?gid=${sheetGid}&tqx=out:json`;
    const handler = function(resp){
      try{
        const cols = (resp.table && resp.table.cols)||[]; const rows = (resp.table && resp.table.rows)||[];
        const header = cols.map(c=> (c && (c.label||c.id))||''); const data=[header];
        rows.forEach(r=>{ const cells=(r.c||[]).map(cell=> (cell && (cell.v!=null?cell.v:''))||''); data.push(cells); });
        resolve(data);
      }catch(err){ reject(err); }
      finally{ if(script && script.parentNode) script.parentNode.removeChild(script); delete window.google?.visualization?.Query?.setResponse; }
    };
    window.google = window.google||{}; window.google.visualization = window.google.visualization||{};
    window.google.visualization.Query = window.google.visualization.Query || {};
    window.google.visualization.Query.setResponse = handler;
    const script = document.createElement('script'); script.src = src; script.onerror = ()=>{ script.remove(); reject(new Error('gviz load error')); }; document.head.appendChild(script);
  });
}

async function renderAndDownload(rows){
  setStatus('Rendering table...');
  const table = renderTable(rows);
  await new Promise(r=>setTimeout(r,150));
  setStatus('Converting to PNG...');
  try{
    const canvas = await html2canvas(table, {
      scale: 1.5,
      backgroundColor: '#ffffff',
      useCORS: true,
      allowTaint: true,
      logging: false
    });
    console.log('Canvas size:', canvas.width, 'x', canvas.height);
    const padding = 4;
    const padded = document.createElement('canvas');
    padded.width = canvas.width + padding*2;
    padded.height = canvas.height + padding*2;
    const ctx = padded.getContext('2d');
    ctx.fillStyle='#ffffff';
    ctx.fillRect(0,0,padded.width,padded.height);
    ctx.drawImage(canvas,padding,padding);
    padded.toBlob(function(blob){
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = (new Date()).toISOString().slice(0,10)+'_postemensuels.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus('Done! Check your Downloads folder.');
    }, 'image/png');
  }catch(err){
    console.error('Canvas error:', err);
    setStatus('Error converting to PNG: '+err.message);
  }
}

btn.addEventListener('click', async ()=>{
  btn.disabled = true;
  setStatus('Starting...');
  const urlParam = getParam('url');
  if(!urlParam){ setStatus('Missing url param'); btn.disabled = false; return; }
  const url = decodeURIComponent(urlParam);
  const csvUrl = makeCsvUrl(url);
  try{
    try{ const rows = await tryFetchCsv(csvUrl); await renderAndDownload(rows); return; }catch(e1){ console.warn('direct fetch failed',e1); }
    try{ const rows = await tryFetchCsv(PROXY + encodeURIComponent(csvUrl)); await renderAndDownload(rows); return; }catch(e2){ console.warn('proxy failed', e2); }
    try{ const rows = await loadViaGvizScript(url); await renderAndDownload(rows); return; }catch(e3){ console.warn('gviz failed', e3); throw new Error('All methods failed'); }
  }catch(err){ setStatus('Failed: '+err.message); alert('Failed to load sheet. Check console.'); }
  finally{ btn.disabled = false; }
});

// Initialize status
window.addEventListener('load', ()=>{ setStatus('Click "Download PNG" to start'); });
</script>
</body>
</html>
